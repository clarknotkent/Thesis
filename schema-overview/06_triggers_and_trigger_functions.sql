-- Triggers with timing, events, conditions and functions
SELECT
  n.nspname AS schema,
  c.relname AS table_name,
  tg.tgname AS trigger_name,
  CASE WHEN (tg.tgtype & 1) <> 0 THEN 'ROW' ELSE 'STATEMENT' END AS level,
  ARRAY[
    CASE WHEN (tg.tgtype & 4) <> 0 THEN 'INSERT' END,
    CASE WHEN (tg.tgtype & 8) <> 0 THEN 'DELETE' END,
    CASE WHEN (tg.tgtype & 16) <> 0 THEN 'UPDATE' END,
    CASE WHEN (tg.tgtype & 32) <> 0 THEN 'TRUNCATE' END
  ] AS events,
  CASE WHEN (tg.tgtype & 2) <> 0 THEN 'BEFORE' WHEN (tg.tgtype & 64) <> 0 THEN 'INSTEAD OF' ELSE 'AFTER' END AS timing,
  pg_get_triggerdef(tg.oid, true) AS trigger_def,
  p.proname AS function_name,
  pg_get_functiondef(p.oid) AS function_def
FROM pg_trigger tg
JOIN pg_class c ON c.oid = tg.tgrelid
JOIN pg_namespace n ON n.oid = c.relnamespace
JOIN pg_proc p ON p.oid = tg.tgfoid
WHERE NOT tg.tgisinternal
  AND n.nspname NOT IN ('pg_catalog','information_schema')
  AND n.nspname NOT LIKE 'pg_toast%'
  AND n.nspname NOT LIKE 'pg_temp%'
ORDER BY schema, table_name, trigger_name;

| schema   | table_name               | trigger_name                                     | level     | events                                  | timing | trigger_def                                                                                                                                                                                                      | function_name                                | function_def                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -------- | ------------------------ | ------------------------------------------------ | --------- | --------------------------------------- | ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| cron     | job                      | cron_job_cache_invalidate                        | STATEMENT | ["INSERT","DELETE","UPDATE","TRUNCATE"] | AFTER  | CREATE TRIGGER cron_job_cache_invalidate AFTER INSERT OR DELETE OR UPDATE OR TRUNCATE ON cron.job FOR EACH STATEMENT EXECUTE FUNCTION cron.job_cache_invalidate()                                                | job_cache_invalidate                         | CREATE OR REPLACE FUNCTION cron.job_cache_invalidate()
 RETURNS trigger
 LANGUAGE c
AS '$libdir/pg_cron', $function$cron_job_cache_invalidate$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public   | activitylogs             | trg_activitylogs_action_type_check               | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_activitylogs_action_type_check BEFORE INSERT OR UPDATE ON activitylogs FOR EACH ROW EXECUTE FUNCTION ensure_activity_action_type()                                                            | ensure_activity_action_type                  | CREATE OR REPLACE FUNCTION public.ensure_activity_action_type()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
        BEGIN
            IF NEW.action_type IS NOT NULL AND NOT EXISTS (
                SELECT 1 FROM activity_action_types WHERE action_type = NEW.action_type
            ) THEN
                RAISE EXCEPTION 'Unknown action_type %', NEW.action_type;
            END IF;
            RETURN NEW;
        END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public   | birthhistory             | set_birthhistory_ts                              | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_birthhistory_ts BEFORE UPDATE ON birthhistory FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                       | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | conversationparticipants | set_conversationparticipants_ts                  | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_conversationparticipants_ts BEFORE UPDATE ON conversationparticipants FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                               | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | conversations            | set_conversations_ts                             | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_conversations_ts BEFORE UPDATE ON conversations FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                     | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | deworming                | set_deworming_ts                                 | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_deworming_ts BEFORE UPDATE ON deworming FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                             | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | guardians                | set_guardians_ts                                 | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_guardians_ts BEFORE UPDATE ON guardians FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                             | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | guardians                | trg_soft_delete_cascade_guardians                | ROW       | [null,null,"UPDATE",null]               | AFTER  | CREATE TRIGGER trg_soft_delete_cascade_guardians AFTER UPDATE OF is_deleted ON guardians FOR EACH ROW WHEN (new.is_deleted = true) EXECUTE FUNCTION soft_delete_cascade_guardians()                              | soft_delete_cascade_guardians                | CREATE OR REPLACE FUNCTION public.soft_delete_cascade_guardians()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    UPDATE patients SET is_deleted = TRUE, deleted_at = NOW(), deleted_by = NEW.deleted_by WHERE guardian_id = NEW.guardian_id;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public   | immunizations            | immunization_issue_inventory                     | ROW       | ["INSERT",null,null,null]               | AFTER  | CREATE TRIGGER immunization_issue_inventory AFTER INSERT ON immunizations FOR EACH ROW EXECUTE FUNCTION trg_immunization_issue_inventory()                                                                       | trg_immunization_issue_inventory             | CREATE OR REPLACE FUNCTION public.trg_immunization_issue_inventory()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.inventory_id IS NOT NULL THEN
        INSERT INTO inventorytransactions(inventory_id, transaction_type, quantity, date, remarks, performed_by, created_by)
        VALUES (NEW.inventory_id, 'ISSUE', 1, now(), 'Auto decrement for immunization '||NEW.immunization_id, NEW.administered_by, NEW.administered_by);
    END IF;
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public   | immunizations            | patientschedule_status_update_trigger            | STATEMENT | ["INSERT",null,null,null]               | AFTER  | CREATE TRIGGER patientschedule_status_update_trigger AFTER INSERT ON immunizations FOR EACH STATEMENT EXECUTE FUNCTION trigger_update_schedule_statuses()                                                        | trigger_update_schedule_statuses             | CREATE OR REPLACE FUNCTION public.trigger_update_schedule_statuses()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_patient_id bigint;
    v_updated_count int := 0;
BEGIN
    -- Prevent recursion by checking a session flag
    IF current_setting('app.schedule_update_in_progress', true) = 'true' THEN
        RETURN COALESCE(NEW, OLD);
    END IF;

    PERFORM set_config('app.schedule_update_in_progress', 'true', false);

    -- Get patient_id from the triggering record (works for INSERT/UPDATE/DELETE)
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        v_patient_id := NEW.patient_id;
    ELSE
        v_patient_id := OLD.patient_id;
    END IF;

    -- Update schedule statuses for this patient only (avoid cascading updates).
    -- Preserve explicit Rescheduled marking if the scheduled_date is still in the future.
    UPDATE patientschedule
    SET status = CASE
        WHEN actual_date IS NOT NULL THEN 'Completed'::text
        WHEN status = 'Rescheduled' AND scheduled_date >= CURRENT_DATE THEN 'Rescheduled'::text
        WHEN scheduled_date < CURRENT_DATE - INTERVAL '30 days' THEN 'Missed'::text
        ELSE 'Pending'::text
    END,
    updated_at = now(),
    updated_by = NULLIF(current_setting('app.user_id', true),'')::bigint
    WHERE patient_id = v_patient_id
    AND is_deleted = false;

    PERFORM set_config('app.schedule_update_in_progress', 'false', false);
    RETURN COALESCE(NEW, OLD);
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| public   | immunizations            | set_immunizations_ts                             | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_immunizations_ts BEFORE UPDATE ON immunizations FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                     | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | immunizations            | trg_set_administered_time                        | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_set_administered_time BEFORE INSERT OR UPDATE ON immunizations FOR EACH ROW EXECUTE FUNCTION set_administered_time()                                                                          | set_administered_time                        | CREATE OR REPLACE FUNCTION public.set_administered_time()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- If administered_time is not set, set appropriate default based on date
    IF NEW.administered_time IS NULL THEN
        IF NEW.administered_date = CURRENT_DATE THEN
            -- For today's date, use current time
            NEW.administered_time = CURRENT_TIME;
        ELSE
            -- For past/future dates, default to 8:00 AM (normal business hours)
            NEW.administered_time = '08:00:00'::TIME;
        END IF;
    END IF;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public   | inventory                | set_inventory_ts                                 | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_inventory_ts BEFORE UPDATE ON inventory FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                             | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | inventory                | trg_inventory_history                            | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_inventory_history AFTER INSERT OR DELETE OR UPDATE ON inventory FOR EACH ROW EXECUTE FUNCTION trg_inventory_history_fn()                                                                      | trg_inventory_history_fn                     | CREATE OR REPLACE FUNCTION public.trg_inventory_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_changed jsonb; v_version int; v_id bigint; v_snapshot jsonb;
BEGIN
    IF TG_OP = 'INSERT' THEN
        v_changed := to_jsonb(NEW);
        v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'UPDATE' THEN
        -- jsonb_diff may return NULL in some environments; coalesce to empty object
        v_changed := COALESCE(jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)), '{}'::jsonb);
        IF v_changed = '{}'::jsonb THEN RETURN NEW; END IF;
        v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'DELETE' THEN
        v_changed := jsonb_build_object('deleted', true);
        v_snapshot := to_jsonb(OLD);
    END IF;

    v_changed := COALESCE(v_changed, '{}'::jsonb);
    v_snapshot := COALESCE(v_snapshot, CASE WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD) ELSE to_jsonb(NEW) END);

    v_id := COALESCE(NEW.inventory_id, OLD.inventory_id);
    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM inventory_history WHERE inventory_id = v_id;
    INSERT INTO inventory_history(inventory_id, version_no, changed_at, changed_by, changed_fields, snapshot)
    VALUES (v_id, v_version, now(), current_setting('app.user_id', true)::bigint, v_changed, v_snapshot);

    IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public   | inventory                | trg_inventory_nonnegative                        | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_inventory_nonnegative BEFORE INSERT OR UPDATE ON inventory FOR EACH ROW EXECUTE FUNCTION enforce_inventory_nonnegative()                                                                      | enforce_inventory_nonnegative                | CREATE OR REPLACE FUNCTION public.enforce_inventory_nonnegative()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
        BEGIN
            IF NEW.current_stock_level < 0 THEN
                RAISE EXCEPTION 'Inventory % would become negative (%).', NEW.inventory_id, NEW.current_stock_level;
            END IF;
            RETURN NEW;
        END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public   | inventory_requests       | set_inventory_requests_ts                        | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_inventory_requests_ts BEFORE UPDATE ON inventory_requests FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                           | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | inventory_requests       | trg_inventory_requests_audit                     | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_inventory_requests_audit BEFORE INSERT OR UPDATE ON inventory_requests FOR EACH ROW EXECUTE FUNCTION trg_inventory_requests_audit()                                                           | trg_inventory_requests_audit                 | CREATE OR REPLACE FUNCTION public.trg_inventory_requests_audit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF TG_OP='INSERT' THEN
        NEW.created_at := now();
        IF NEW.created_by IS NULL THEN NEW.created_by := NULLIF(current_setting('app.user_id', true),'')::bigint; END IF;
    ELSE
        NEW.updated_at := now();
        NEW.updated_by := NULLIF(current_setting('app.user_id', true),'')::bigint;
    END IF;
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public   | inventorytransactions    | set_inventorytransactions_ts                     | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_inventorytransactions_ts BEFORE UPDATE ON inventorytransactions FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                     | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | inventorytransactions    | trg_inventorytransactions_activity               | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_inventorytransactions_activity AFTER INSERT OR DELETE OR UPDATE ON inventorytransactions FOR EACH ROW EXECUTE FUNCTION trg_inventorytransactions_activity_fn()                                | trg_inventorytransactions_activity_fn        | CREATE OR REPLACE FUNCTION public.trg_inventorytransactions_activity_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$DECLARE
    v_actor bigint; v_target bigint; v_action text; v_old jsonb; v_new jsonb;
    v_type text; v_qty int;
BEGIN
    v_actor := current_setting('app.user_id', true)::bigint;
    IF TG_OP = 'INSERT' THEN
        v_old := NULL; v_new := to_jsonb(NEW); v_target := NEW.inventory_id;
        v_type := NEW.transaction_type;
        v_qty := NEW.quantity;
        -- Map transaction types to inventory action types
        IF v_type IN ('RECEIVE') THEN
            v_action := 'INVENTORY_STOCK_ADDED';
        ELSIF v_type IN ('ISSUE') THEN
            v_action := 'INVENTORY_STOCK_REMOVED';
        ELSIF v_type IN ('ADJUST') THEN
            v_action := 'INVENTORY_STOCK_ADJUSTED';
        ELSIF v_type IN ('RETURN') THEN
            v_action := 'INVENTORY_STOCK_TRANSFERRED';
        ELSIF v_type IN ('EXPIRED') THEN
            v_action := 'INVENTORY_STOCK_EXPIRED';
        ELSE
            -- Fallback for unknown transaction types
            v_action := 'INVENTORY_STOCK_ADJUSTED';
        END IF;
    ELSIF TG_OP = 'UPDATE' THEN
        v_old := to_jsonb(OLD); v_new := to_jsonb(NEW); v_target := NEW.inventory_id;
        IF jsonb_diff(v_old, v_new) = '{}'::jsonb THEN RETURN NEW; END IF;
        v_type := NEW.transaction_type; v_qty := NEW.quantity;
        IF v_type IN ('RECEIVE') THEN v_action := 'INVENTORY_STOCK_ADDED';
        ELSIF v_type IN ('ISSUE') THEN v_action := 'INVENTORY_STOCK_REMOVED';
        ELSIF v_type IN ('ADJUST') THEN v_action := 'INVENTORY_STOCK_ADJUSTED';
        ELSIF v_type IN ('RETURN') THEN v_action := 'INVENTORY_STOCK_TRANSFERRED';
        ELSIF v_type IN ('EXPIRED') THEN v_action := 'INVENTORY_STOCK_EXPIRED';
        ELSE v_action := 'INVENTORY_STOCK_ADJUSTED'; END IF;
    ELSIF TG_OP = 'DELETE' THEN
        v_old := to_jsonb(OLD); v_new := NULL; v_target := OLD.inventory_id; v_action := 'INVENTORY_DELETE';
    END IF;
    INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp, description)
    VALUES (v_actor, v_action, 'INVENTORY', v_target, v_old, v_new, now(), 'Inventory Updated');
    RETURN COALESCE(NEW, OLD);
END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public   | inventorytransactions    | trg_inventorytransactions_apply                  | ROW       | ["INSERT",null,null,null]               | BEFORE | CREATE TRIGGER trg_inventorytransactions_apply BEFORE INSERT ON inventorytransactions FOR EACH ROW EXECUTE FUNCTION trg_inventory_transaction_apply()                                                            | trg_inventory_transaction_apply              | CREATE OR REPLACE FUNCTION public.trg_inventory_transaction_apply()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    current_level int;
    new_level int;
BEGIN
    -- Quantity validation: for ADJUST allow zero (set absolute to 0), others must be positive
    IF NEW.transaction_type = 'ADJUST' THEN
        IF NEW.quantity < 0 THEN
            RAISE EXCEPTION 'Quantity must not be negative for ADJUST';
        END IF;
    ELSE
        IF NEW.quantity <= 0 THEN
            RAISE EXCEPTION 'Quantity must be positive';
        END IF;
    END IF;

    -- Lock current inventory row
    SELECT current_stock_level INTO current_level
    FROM public.inventory
    WHERE inventory_id = NEW.inventory_id
    FOR UPDATE;

    IF current_level IS NULL THEN
        RAISE EXCEPTION 'Inventory % not found', NEW.inventory_id;
    END IF;

    -- Apply semantics
    IF NEW.transaction_type = 'ADJUST' THEN
        -- ADJUST means set absolute stock level to NEW.quantity
        new_level := NEW.quantity;
    ELSIF NEW.transaction_type IN ('RECEIVE') THEN
        new_level := current_level + NEW.quantity;
    ELSIF NEW.transaction_type IN ('ISSUE','EXPIRED','RETURN') THEN
        new_level := current_level - NEW.quantity;
    ELSE
        RAISE EXCEPTION 'Unsupported transaction_type: %', NEW.transaction_type;
    END IF;

    IF new_level < 0 THEN
        RAISE EXCEPTION 'Stock would become negative (inventory_id %, after %)', NEW.inventory_id, new_level;
    END IF;

    UPDATE public.inventory
    SET current_stock_level = new_level,
        updated_at = now()
    WHERE inventory_id = NEW.inventory_id;

    NEW.balance_after := new_level;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public   | inventorytransactions    | trg_inventorytransactions_history                | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_inventorytransactions_history AFTER INSERT OR DELETE OR UPDATE ON inventorytransactions FOR EACH ROW EXECUTE FUNCTION trg_inventorytransactions_history_fn()                                  | trg_inventorytransactions_history_fn         | CREATE OR REPLACE FUNCTION public.trg_inventorytransactions_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_version int;
    v_id bigint;
BEGIN
    -- Determine primary key value depending on operation
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        v_id := NEW.transaction_id;
    ELSE
        v_id := OLD.transaction_id; -- DELETE
    END IF;

    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM inventorytransactions_history WHERE transaction_id = v_id;

    INSERT INTO inventorytransactions_history(transaction_id, version_no, changed_by, changed_fields, snapshot)
    VALUES (
        v_id,
        v_version,
        NULLIF(current_setting('app.user_id', true),'')::bigint,
        CASE WHEN TG_OP = 'UPDATE' THEN jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)) ELSE NULL END,
        to_jsonb(CASE WHEN TG_OP = 'DELETE' THEN OLD ELSE NEW END)
    );
    RETURN NULL; -- AFTER trigger ignores return tuple
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public   | messages                 | set_messages_ts                                  | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_messages_ts BEFORE UPDATE ON messages FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                               | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | messages                 | trg_messages_activity_legacy                     | ROW       | ["INSERT",null,"UPDATE",null]           | AFTER  | CREATE TRIGGER trg_messages_activity_legacy AFTER INSERT OR UPDATE ON messages FOR EACH ROW EXECUTE FUNCTION trg_messages_activity_legacy()                                                                      | trg_messages_activity_legacy                 | CREATE OR REPLACE FUNCTION public.trg_messages_activity_legacy()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE v_actor bigint := NULLIF(current_setting('app.user_id', true),'')::bigint; BEGIN
    IF TG_OP='INSERT' THEN
        INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
        VALUES (v_actor, 'MESSAGE_CREATED', 'messages', NEW.message_id, NULL, jsonb_build_object('conversation_id', NEW.conversation_id, 'sender_id', NEW.sender_id), now());
    ELSIF TG_OP='UPDATE' THEN
        IF NEW.read_at IS NOT NULL AND OLD.read_at IS NULL THEN
            INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
            VALUES (v_actor, 'MESSAGE_READ', 'messages', NEW.message_id, NULL, jsonb_build_object('read_at', NEW.read_at), now());
        END IF;
        IF NEW.is_deleted AND NOT OLD.is_deleted THEN
            INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
            VALUES (v_actor, 'MESSAGE_DELETED', 'messages', NEW.message_id, to_jsonb(OLD), NULL, now());
        END IF;
    END IF;
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public   | notifications            | set_notifications_ts                             | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_notifications_ts BEFORE UPDATE ON notifications FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                     | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | notifications            | trg_notifications_activity_legacy                | ROW       | ["INSERT",null,"UPDATE",null]           | AFTER  | CREATE TRIGGER trg_notifications_activity_legacy AFTER INSERT OR UPDATE ON notifications FOR EACH ROW EXECUTE FUNCTION trg_notifications_activity_legacy()                                                       | trg_notifications_activity_legacy            | CREATE OR REPLACE FUNCTION public.trg_notifications_activity_legacy()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$DECLARE v_actor bigint := NULLIF(current_setting('app.user_id', true),'')::bigint; BEGIN
    IF TG_OP='INSERT' THEN
        INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
        VALUES (v_actor, 'NOTIFICATION_CREATE', 'notifications', NEW.notification_id, NULL, to_jsonb(NEW), now());
    ELSIF TG_OP='UPDATE' THEN
        IF NEW.status='read' AND (OLD.status IS DISTINCT FROM NEW.status) THEN
            INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
            VALUES (v_actor, 'NOTIFICATION_READ', 'notifications', NEW.notification_id, NULL, jsonb_build_object('status', NEW.status, 'read_at', NEW.read_at), now());
        END IF;
        IF NEW.is_deleted AND NOT OLD.is_deleted THEN
            INSERT INTO activitylogs(user_id, action_type, entity_type, entity_id, old_value, new_value, timestamp)
            VALUES (v_actor, 'NOTIFICATION_DELETED', 'notifications', NEW.notification_id, to_jsonb(OLD), NULL, now());
        END IF;
    END IF;
    RETURN NEW;
END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public   | notifications            | trg_notifications_reconcile_audit                | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER trg_notifications_reconcile_audit BEFORE UPDATE ON notifications FOR EACH ROW EXECUTE FUNCTION trg_notifications_reconcile_audit()                                                                | trg_notifications_reconcile_audit            | CREATE OR REPLACE FUNCTION public.trg_notifications_reconcile_audit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE v_actor bigint := NULLIF(current_setting('app.user_id', true),'')::bigint; BEGIN
    IF TG_OP='UPDATE' THEN
        IF NEW.is_deleted AND (NOT OLD.is_deleted) THEN
            NEW.deleted_at := COALESCE(NEW.deleted_at, now());
            NEW.deleted_by := COALESCE(NEW.deleted_by, v_actor);
        END IF;
        IF NEW.status = 'read' AND OLD.status IS DISTINCT FROM NEW.status THEN
            NEW.read_at := COALESCE(NEW.read_at, now());
        END IF;
    END IF;
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| public   | patients                 | set_patients_ts                                  | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_patients_ts BEFORE UPDATE ON patients FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                               | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | patients                 | trg_create_patientschedule_on_patient_insert     | ROW       | ["INSERT",null,null,null]               | AFTER  | CREATE TRIGGER trg_create_patientschedule_on_patient_insert AFTER INSERT ON patients FOR EACH ROW EXECUTE FUNCTION create_patientschedule_on_patient_insert()                                                    | create_patientschedule_on_patient_insert     | CREATE OR REPLACE FUNCTION public.create_patientschedule_on_patient_insert()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Delegate to canonical generator which uses schedule_master / schedule_doses
    PERFORM generate_patient_schedule(NEW.patient_id, NEW.created_by);
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| public   | patients                 | trg_patients_history                             | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_patients_history AFTER INSERT OR DELETE OR UPDATE ON patients FOR EACH ROW EXECUTE FUNCTION trg_patients_history_fn()                                                                         | trg_patients_history_fn                      | CREATE OR REPLACE FUNCTION public.trg_patients_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_changed jsonb; v_version int; v_id bigint; v_snapshot jsonb;
BEGIN
    IF TG_OP = 'INSERT' THEN v_changed := to_jsonb(NEW); v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'UPDATE' THEN v_changed := jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)); IF v_changed = '{}'::jsonb THEN RETURN NEW; END IF; v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'DELETE' THEN v_changed := jsonb_build_object('deleted', true); v_snapshot := to_jsonb(OLD);
    END IF;
    v_id := COALESCE(NEW.patient_id, OLD.patient_id);
    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM patients_history WHERE patient_id = v_id;
    INSERT INTO patients_history(patient_id, version_no, changed_at, changed_by, changed_fields, snapshot)
    VALUES (v_id, v_version, now(), current_setting('app.user_id', true)::bigint, v_changed, v_snapshot);
    IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public   | patients                 | trg_patients_qr_nonce                            | ROW       | ["INSERT",null,null,null]               | BEFORE | CREATE TRIGGER trg_patients_qr_nonce BEFORE INSERT ON patients FOR EACH ROW EXECUTE FUNCTION ensure_patient_qr_nonce()                                                                                           | ensure_patient_qr_nonce                      | CREATE OR REPLACE FUNCTION public.ensure_patient_qr_nonce()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  if NEW.qr_nonce is null then
    NEW.qr_nonce := gen_random_uuid();
  end if;
  return NEW;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public   | patients                 | trg_soft_delete_cascade_patients                 | ROW       | [null,null,"UPDATE",null]               | AFTER  | CREATE TRIGGER trg_soft_delete_cascade_patients AFTER UPDATE OF is_deleted ON patients FOR EACH ROW WHEN (new.is_deleted = true) EXECUTE FUNCTION soft_delete_cascade_patients()                                 | soft_delete_cascade_patients                 | CREATE OR REPLACE FUNCTION public.soft_delete_cascade_patients()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    UPDATE visits SET is_deleted = TRUE, deleted_at = NOW(), deleted_by = NEW.deleted_by WHERE patient_id = NEW.patient_id;
    UPDATE patientschedule SET is_deleted = TRUE, deleted_at = NOW(), deleted_by = NEW.deleted_by WHERE patient_id = NEW.patient_id;
    UPDATE birthhistory SET is_deleted = TRUE, deleted_at = NOW(), deleted_by = NEW.deleted_by WHERE patient_id = NEW.patient_id;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public   | patientschedule          | patientschedule_status_update_trigger            | STATEMENT | ["INSERT",null,"UPDATE",null]           | AFTER  | CREATE TRIGGER patientschedule_status_update_trigger AFTER INSERT OR UPDATE ON patientschedule FOR EACH STATEMENT EXECUTE FUNCTION trigger_update_schedule_statuses()                                            | trigger_update_schedule_statuses             | CREATE OR REPLACE FUNCTION public.trigger_update_schedule_statuses()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_patient_id bigint;
    v_updated_count int := 0;
BEGIN
    -- Prevent recursion by checking a session flag
    IF current_setting('app.schedule_update_in_progress', true) = 'true' THEN
        RETURN COALESCE(NEW, OLD);
    END IF;

    PERFORM set_config('app.schedule_update_in_progress', 'true', false);

    -- Get patient_id from the triggering record (works for INSERT/UPDATE/DELETE)
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        v_patient_id := NEW.patient_id;
    ELSE
        v_patient_id := OLD.patient_id;
    END IF;

    -- Update schedule statuses for this patient only (avoid cascading updates).
    -- Preserve explicit Rescheduled marking if the scheduled_date is still in the future.
    UPDATE patientschedule
    SET status = CASE
        WHEN actual_date IS NOT NULL THEN 'Completed'::text
        WHEN status = 'Rescheduled' AND scheduled_date >= CURRENT_DATE THEN 'Rescheduled'::text
        WHEN scheduled_date < CURRENT_DATE - INTERVAL '30 days' THEN 'Missed'::text
        ELSE 'Pending'::text
    END,
    updated_at = now(),
    updated_by = NULLIF(current_setting('app.user_id', true),'')::bigint
    WHERE patient_id = v_patient_id
    AND is_deleted = false;

    PERFORM set_config('app.schedule_update_in_progress', 'false', false);
    RETURN COALESCE(NEW, OLD);
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| public   | patientschedule          | set_patientschedule_ts                           | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_patientschedule_ts BEFORE UPDATE ON patientschedule FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                 | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | patientschedule          | trg_enforce_vaccine_interval                     | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_enforce_vaccine_interval BEFORE INSERT OR UPDATE ON patientschedule FOR EACH ROW EXECUTE FUNCTION enforce_vaccine_interval()                                                                  | enforce_vaccine_interval                     | CREATE OR REPLACE FUNCTION public.enforce_vaccine_interval()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_min_interval INTEGER;
    v_max_interval INTEGER;
    v_min_interval_other INTEGER;
    v_concurrent BOOLEAN;
    v_dob DATE;
    v_due_after INTEGER;
    v_baseline_due DATE;
    v_other_nearest DATE;
    v_other_concurrent BOOLEAN;
    v_other_diff INTEGER;
    v_candidate DATE := NEW.scheduled_date::date;
    v_ctx text := current_setting('app.reschedule_ctx', true);
BEGIN
    -- Skip enforcement on UPDATEs that do not change scheduled_date (e.g., status-only updates)
    IF TG_OP = 'UPDATE' AND NEW.scheduled_date IS NOT DISTINCT FROM OLD.scheduled_date THEN
        RETURN NEW;
    END IF;

    -- Gather patient DOB and schedule metadata
    SELECT p.date_of_birth INTO v_dob FROM patients p WHERE p.patient_id = NEW.patient_id;

    -- Determine schedule metadata for the exact (vaccine_id, dose_number)
    IF NEW.dose_number IS NULL THEN
        RAISE EXCEPTION 'Dose number is required to enforce schedule rules.';
    END IF;

    SELECT sd.min_interval_days,
           sd.max_interval_days,
           sd.min_interval_other_vax,
           sm.concurrent_allowed,
           sd.due_after_days
    INTO v_min_interval, v_max_interval, v_min_interval_other, v_concurrent, v_due_after
    FROM schedule_doses sd
    JOIN schedule_master sm ON sd.schedule_id = sm.id
    WHERE sm.vaccine_id = NEW.vaccine_id
      AND sd.dose_number = NEW.dose_number
      AND COALESCE(sm.is_deleted, false) = false
      AND COALESCE(sd.is_deleted, false) = false
    ORDER BY sm.id ASC
    LIMIT 1;

    IF v_due_after IS NULL THEN
        RAISE EXCEPTION 'Missing schedule definition: vaccine_id %, dose_number %', NEW.vaccine_id, NEW.dose_number;
    END IF;

    -- Compute baseline due date (DOB + due_after_days) if available
    IF v_dob IS NOT NULL AND v_due_after IS NOT NULL THEN
        v_baseline_due := (v_dob + (v_due_after * INTERVAL '1 day'))::date;
    ELSE
        v_baseline_due := NULL;
    END IF;

    -- 1) DAD baseline hard check: never allow scheduling earlier than baseline due (DOB + due_after_days)
    IF v_baseline_due IS NOT NULL AND v_candidate < v_baseline_due THEN
        RAISE EXCEPTION 'PS:% V:% D:%  Scheduled date (%) cannot be earlier than baseline due_after_days (%).', NEW.patient_schedule_id, NEW.vaccine_id, NEW.dose_number, v_candidate, v_baseline_due;
    END IF;

    -- 2) Same vaccine doses same-day prohibition (skip during DFS to allow sequential correction)
    IF COALESCE(v_ctx,'') <> 'dfs' AND EXISTS (
        SELECT 1 FROM patientschedule ps
        WHERE ps.patient_id = NEW.patient_id AND ps.vaccine_id = NEW.vaccine_id AND ps.dose_number <> NEW.dose_number
          AND COALESCE(ps.is_deleted,false) = false AND COALESCE(ps.actual_date, ps.scheduled_date)::date = v_candidate
    ) THEN
        RAISE EXCEPTION 'Same vaccine doses cannot share the same day (%).', v_candidate;
    END IF;

    -- 3) Same-day concurrency symmetry (skip during DFS orchestration to allow temporary states)
    IF COALESCE(v_ctx,'') <> 'dfs' AND EXISTS (
        SELECT 1
        FROM patientschedule ps
        JOIN schedule_master sm2 ON sm2.vaccine_id = ps.vaccine_id
        WHERE ps.patient_id = NEW.patient_id AND ps.vaccine_id <> NEW.vaccine_id
          AND COALESCE(ps.is_deleted,false) = false AND COALESCE(ps.actual_date, ps.scheduled_date)::date = v_candidate
          AND NOT (COALESCE(v_concurrent,false) AND COALESCE(sm2.concurrent_allowed,false))
    ) THEN
        RAISE EXCEPTION 'Same-day concurrency disallowed by one of the vaccines (%).', v_candidate;
    END IF;

    -- 4) Cross-vaccine minimum spacing (skip during DFS orchestration to allow temporary states)
    IF COALESCE(v_ctx,'') <> 'dfs' AND v_min_interval_other IS NOT NULL THEN
        SELECT COALESCE(ps.actual_date, ps.scheduled_date)::date AS odate, sm2.concurrent_allowed
        INTO v_other_nearest, v_other_concurrent
        FROM patientschedule ps
        JOIN schedule_master sm2 ON sm2.vaccine_id = ps.vaccine_id
        WHERE ps.patient_id = NEW.patient_id AND ps.vaccine_id <> NEW.vaccine_id AND COALESCE(ps.is_deleted,false) = false
        ORDER BY ABS((COALESCE(ps.actual_date, ps.scheduled_date))::date - v_candidate)
        LIMIT 1;

        IF v_other_nearest IS NOT NULL THEN
            v_other_diff := ABS(v_candidate - v_other_nearest);
            IF v_other_diff = 0 THEN
                IF COALESCE(v_concurrent,false) AND COALESCE(v_other_concurrent,false) THEN
                    -- same-day allowed by both; ok
                ELSE
                    RAISE EXCEPTION 'Same-day scheduling not allowed due to concurrency rule (%).', v_candidate;
                END IF;
            ELSIF v_other_diff < v_min_interval_other THEN
                RAISE EXCEPTION 'Too close to other vaccine date (diff % days; min % days).', v_other_diff, v_min_interval_other;
            END IF;
        END IF;
    END IF;

    RETURN NEW;
END;
$function$
 |
| public   | patientschedule          | trg_patientschedule_history                      | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_patientschedule_history AFTER INSERT OR DELETE OR UPDATE ON patientschedule FOR EACH ROW EXECUTE FUNCTION trg_patientschedule_history_fn()                                                    | trg_patientschedule_history_fn               | CREATE OR REPLACE FUNCTION public.trg_patientschedule_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_changed jsonb; v_version int; v_id bigint; v_snapshot jsonb;
BEGIN
    IF TG_OP = 'INSERT' THEN v_changed := to_jsonb(NEW); v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'UPDATE' THEN v_changed := jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)); IF v_changed = '{}'::jsonb THEN RETURN NEW; END IF; v_snapshot := to_jsonb(NEW);
    ELSIF TG_OP = 'DELETE' THEN v_changed := jsonb_build_object('deleted', true); v_snapshot := to_jsonb(OLD);
    END IF;
    v_id := COALESCE(NEW.patient_schedule_id, OLD.patient_schedule_id);
    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM patientschedule_history WHERE patient_schedule_id = v_id;
    INSERT INTO patientschedule_history(patient_schedule_id, version_no, changed_at, changed_by, changed_fields, snapshot)
    VALUES (v_id, v_version, now(), current_setting('app.user_id', true)::bigint, v_changed, v_snapshot);
    IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public   | patientschedule          | trg_update_patient_fic_cic_tag                   | ROW       | ["INSERT",null,"UPDATE",null]           | AFTER  | CREATE TRIGGER trg_update_patient_fic_cic_tag AFTER INSERT OR UPDATE ON patientschedule FOR EACH ROW EXECUTE FUNCTION update_patient_fic_cic_tag()                                                               | update_patient_fic_cic_tag                   | CREATE OR REPLACE FUNCTION public.update_patient_fic_cic_tag()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$DECLARE
    v_completed_count INTEGER;     -- how many doses patient has completed
    v_total_required INTEGER;      -- how many doses patient should complete
    v_latest_completion DATE;      -- date of last completed dose
    v_dob DATE;                    -- patients date of birth
BEGIN
    -- Get patient's DOB
    SELECT date_of_birth INTO v_dob
    FROM patients
    WHERE patient_id = NEW.patient_id;

    -- Get total required doses from schedule_master
    SELECT COALESCE(SUM(total_doses), 0) INTO v_total_required
    FROM schedule_master
    WHERE is_deleted = FALSE;

    -- Get how many doses this patient has completed
    SELECT COUNT(*) INTO v_completed_count
    FROM patientschedule
    WHERE patient_id = NEW.patient_id
      AND status = 'Completed'
      AND is_deleted = FALSE;

    -- Get latest completion date for this patient
    SELECT MAX(actual_date) INTO v_latest_completion
    FROM patientschedule
    WHERE patient_id = NEW.patient_id
      AND status = 'Completed'
      AND is_deleted = FALSE;

    -- If patient has completed all required doses
    IF v_completed_count = v_total_required THEN
        -- Check if all were completed within 12 months 29 days from DOB
        IF v_latest_completion <= (v_dob + INTERVAL '12 months 29 days') THEN
            UPDATE patients
            SET tags = 'FIC'
            WHERE patient_id = NEW.patient_id;
        ELSE
            UPDATE patients
            SET tags = 'CIC'
            WHERE patient_id = NEW.patient_id;
        END IF;
    END IF;

    RETURN NEW;
END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public   | patientschedule          | trg_update_patient_tag_on_patientschedule_update | ROW       | ["INSERT",null,"UPDATE",null]           | AFTER  | CREATE TRIGGER trg_update_patient_tag_on_patientschedule_update AFTER INSERT OR UPDATE ON patientschedule FOR EACH ROW EXECUTE FUNCTION update_patient_tag_on_patientschedule_update()                           | update_patient_tag_on_patientschedule_update | CREATE OR REPLACE FUNCTION public.update_patient_tag_on_patientschedule_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$DECLARE
    v_missed_count INTEGER;
    v_current_tags TEXT;
BEGIN
    -- Check current tags - don't override FIC/CIC status
    SELECT tags INTO v_current_tags FROM patients WHERE patient_id = NEW.patient_id;

    -- If patient already has FIC or CIC status, don't change it
    IF v_current_tags IN ('FIC', 'CIC') THEN
        RETURN NEW;
    END IF;

    -- Otherwise, set Defaulter or None based on missed doses
    SELECT COUNT(*) INTO v_missed_count
    FROM patientschedule ps
    WHERE ps.patient_id = NEW.patient_id AND ps.status = 'Missed' AND ps.is_deleted = FALSE;

    IF v_missed_count > 0 THEN
        UPDATE patients SET tags = 'Defaulter' WHERE patient_id = NEW.patient_id;
    ELSE
        UPDATE patients SET tags = 'None' WHERE patient_id = NEW.patient_id;
    END IF;

    RETURN NEW;
END;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public   | receiving_report_items   | trg_populate_item_manufacturer                   | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER trg_populate_item_manufacturer BEFORE INSERT OR UPDATE ON receiving_report_items FOR EACH ROW EXECUTE FUNCTION populate_item_manufacturer()                                                       | populate_item_manufacturer                   | CREATE OR REPLACE FUNCTION public.populate_item_manufacturer()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.vaccine_id IS NOT NULL THEN
        -- Backfill manufacturer, antigen, and brand from master if missing
        IF NEW.manufacturer IS NULL THEN
            SELECT manufacturer INTO NEW.manufacturer
            FROM vaccinemaster WHERE vaccine_id = NEW.vaccine_id;
        END IF;
        IF NEW.antigen_name IS NULL OR NEW.brand_name IS NULL THEN
            SELECT antigen_name, brand_name INTO NEW.antigen_name, NEW.brand_name
            FROM vaccinemaster WHERE vaccine_id = NEW.vaccine_id;
        END IF;
    END IF;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public   | schedule_doses           | set_schedule_doses_ts                            | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_schedule_doses_ts BEFORE UPDATE ON schedule_doses FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                   | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | schedule_master          | set_schedule_master_ts                           | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_schedule_master_ts BEFORE UPDATE ON schedule_master FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                 | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | user_mapping             | trg_user_mapping_lock_uuid                       | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER trg_user_mapping_lock_uuid BEFORE UPDATE OF uuid ON user_mapping FOR EACH ROW EXECUTE FUNCTION trg_user_mapping_lock_uuid()                                                                       | trg_user_mapping_lock_uuid                   | CREATE OR REPLACE FUNCTION public.trg_user_mapping_lock_uuid()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF TG_OP = 'UPDATE' AND NEW.uuid IS DISTINCT FROM OLD.uuid THEN
        -- Allow change only if the old value is NULL OR the session has elevated role
        IF OLD.uuid IS NOT NULL AND COALESCE(public.current_app_role(), current_setting('app.role', true)) NOT IN ('service','Admin','admin') THEN
            RAISE EXCEPTION 'user_mapping.uuid is immutable once set (user_id %). Use force_link_supabase_user() for overrides.', NEW.user_id;
        END IF;
    END IF;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| public   | users                    | set_users_timestamp                              | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_users_timestamp BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp()                                                                                                      | trg_set_timestamp                            | CREATE OR REPLACE FUNCTION public.trg_set_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| public   | users                    | users_history_trigger                            | ROW       | [null,null,"UPDATE",null]               | AFTER  | CREATE TRIGGER users_history_trigger AFTER UPDATE ON users FOR EACH ROW EXECUTE FUNCTION trg_users_history()                                                                                                     | trg_users_history                            | CREATE OR REPLACE FUNCTION public.trg_users_history()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_version int;
BEGIN
    IF TG_OP = 'UPDATE' THEN
        SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM users_history WHERE user_id = OLD.user_id;
        INSERT INTO users_history(user_id, version_no, changed_by, changed_fields, snapshot)
        VALUES (OLD.user_id, v_version, NEW.updated_by, jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)), to_jsonb(NEW));
    END IF;
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public   | vaccinemaster            | set_vaccinemaster_ts                             | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_vaccinemaster_ts BEFORE UPDATE ON vaccinemaster FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                     | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | visits                   | set_visits_ts                                    | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_visits_ts BEFORE UPDATE ON visits FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                                   | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | visits                   | trg_visits_history                               | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_visits_history AFTER INSERT OR DELETE OR UPDATE ON visits FOR EACH ROW EXECUTE FUNCTION trg_visits_history_fn()                                                                               | trg_visits_history_fn                        | CREATE OR REPLACE FUNCTION public.trg_visits_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_version int;
    v_id bigint;
BEGIN
    -- Determine primary key value depending on operation
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        v_id := NEW.visit_id;
    ELSE
        v_id := OLD.visit_id; -- DELETE
    END IF;

    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM visits_history WHERE visit_id = v_id;

    INSERT INTO visits_history(visit_id, version_no, changed_by, changed_fields, snapshot)
    VALUES (
        v_id,
        v_version,
        NULLIF(current_setting('app.user_id', true),'')::bigint,
        CASE WHEN TG_OP = 'UPDATE' THEN jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)) ELSE NULL END,
        to_jsonb(CASE WHEN TG_OP = 'DELETE' THEN OLD ELSE NEW END)
    );
    RETURN NULL; -- AFTER trigger ignores return tuple
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public   | vitalsigns               | set_vitalsigns_ts                                | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_vitalsigns_ts BEFORE UPDATE ON vitalsigns FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                           | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | vitamina                 | set_vitamina_ts                                  | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER set_vitamina_ts BEFORE UPDATE ON vitamina FOR EACH ROW EXECUTE FUNCTION trg_set_timestamp_generic()                                                                                               | trg_set_timestamp_generic                    | CREATE OR REPLACE FUNCTION public.trg_set_timestamp_generic()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public   | vitamina                 | trg_vitamina_history                             | ROW       | ["INSERT","DELETE","UPDATE",null]       | AFTER  | CREATE TRIGGER trg_vitamina_history AFTER INSERT OR DELETE OR UPDATE ON vitamina FOR EACH ROW EXECUTE FUNCTION trg_vitamina_history_fn()                                                                         | trg_vitamina_history_fn                      | CREATE OR REPLACE FUNCTION public.trg_vitamina_history_fn()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_version int;
    v_id bigint;
BEGIN
    -- Determine primary key value depending on operation
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        v_id := NEW.vitamina_id;
    ELSE
        v_id := OLD.vitamina_id; -- DELETE
    END IF;

    SELECT COALESCE(MAX(version_no),0)+1 INTO v_version FROM vitamina_history WHERE vitamina_id = v_id;

    INSERT INTO vitamina_history(vitamina_id, version_no, changed_by, changed_fields, snapshot)
    VALUES (
        v_id,
        v_version,
        NULLIF(current_setting('app.user_id', true),'')::bigint,
        CASE WHEN TG_OP = 'UPDATE' THEN jsonb_diff(to_jsonb(OLD), to_jsonb(NEW)) ELSE NULL END,
        to_jsonb(CASE WHEN TG_OP = 'DELETE' THEN OLD ELSE NEW END)
    );
    RETURN NULL; -- AFTER trigger ignores return tuple
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| realtime | subscription             | tr_check_filters                                 | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER tr_check_filters BEFORE INSERT OR UPDATE ON realtime.subscription FOR EACH ROW EXECUTE FUNCTION realtime.subscription_check_filters()                                                             | subscription_check_filters                   | CREATE OR REPLACE FUNCTION realtime.subscription_check_filters()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
    /*
    Validates that the user defined filters for a subscription:
    - refer to valid columns that the claimed role may access
    - values are coercable to the correct column type
    */
    declare
        col_names text[] = coalesce(
                array_agg(c.column_name order by c.ordinal_position),
                '{}'::text[]
            )
            from
                information_schema.columns c
            where
                format('%I.%I', c.table_schema, c.table_name)::regclass = new.entity
                and pg_catalog.has_column_privilege(
                    (new.claims ->> 'role'),
                    format('%I.%I', c.table_schema, c.table_name)::regclass,
                    c.column_name,
                    'SELECT'
                );
        filter realtime.user_defined_filter;
        col_type regtype;

        in_val jsonb;
    begin
        for filter in select * from unnest(new.filters) loop
            -- Filtered column is valid
            if not filter.column_name = any(col_names) then
                raise exception 'invalid column for filter %', filter.column_name;
            end if;

            -- Type is sanitized and safe for string interpolation
            col_type = (
                select atttypid::regtype
                from pg_catalog.pg_attribute
                where attrelid = new.entity
                      and attname = filter.column_name
            );
            if col_type is null then
                raise exception 'failed to lookup type for column %', filter.column_name;
            end if;

            -- Set maximum number of entries for in filter
            if filter.op = 'in'::realtime.equality_op then
                in_val = realtime.cast(filter.value, (col_type::text || '[]')::regtype);
                if coalesce(jsonb_array_length(in_val), 0) > 100 then
                    raise exception 'too many values for `in` filter. Maximum 100';
                end if;
            else
                -- raises an exception if value is not coercable to type
                perform realtime.cast(filter.value, col_type);
            end if;

        end loop;

        -- Apply consistent order to filters so the unique constraint on
        -- (subscription_id, entity, filters) can't be tricked by a different filter order
        new.filters = coalesce(
            array_agg(f order by f.column_name, f.op, f.value),
            '{}'
        ) from unnest(new.filters) f;

        return new;
    end;
    $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| storage  | buckets                  | enforce_bucket_name_length_trigger               | ROW       | ["INSERT",null,"UPDATE",null]           | BEFORE | CREATE TRIGGER enforce_bucket_name_length_trigger BEFORE INSERT OR UPDATE OF name ON storage.buckets FOR EACH ROW EXECUTE FUNCTION storage.enforce_bucket_name_length()                                          | enforce_bucket_name_length                   | CREATE OR REPLACE FUNCTION storage.enforce_bucket_name_length()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
    if length(new.name) > 100 then
        raise exception 'bucket name "%" is too long (% characters). Max is 100.', new.name, length(new.name);
    end if;
    return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| storage  | objects                  | objects_delete_delete_prefix                     | ROW       | [null,"DELETE",null,null]               | AFTER  | CREATE TRIGGER objects_delete_delete_prefix AFTER DELETE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.delete_prefix_hierarchy_trigger()                                                              | delete_prefix_hierarchy_trigger              | CREATE OR REPLACE FUNCTION storage.delete_prefix_hierarchy_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    prefix text;
BEGIN
    prefix := "storage"."get_prefix"(OLD."name");

    IF coalesce(prefix, '') != '' THEN
        PERFORM "storage"."delete_prefix"(OLD."bucket_id", prefix);
    END IF;

    RETURN OLD;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| storage  | objects                  | objects_insert_create_prefix                     | ROW       | ["INSERT",null,null,null]               | BEFORE | CREATE TRIGGER objects_insert_create_prefix BEFORE INSERT ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.objects_insert_prefix_trigger()                                                               | objects_insert_prefix_trigger                | CREATE OR REPLACE FUNCTION storage.objects_insert_prefix_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    NEW.level := "storage"."get_level"(NEW."name");

    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| storage  | objects                  | objects_update_create_prefix                     | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER objects_update_create_prefix BEFORE UPDATE ON storage.objects FOR EACH ROW WHEN (new.name <> old.name OR new.bucket_id <> old.bucket_id) EXECUTE FUNCTION storage.objects_update_prefix_trigger() | objects_update_prefix_trigger                | CREATE OR REPLACE FUNCTION storage.objects_update_prefix_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    old_prefixes TEXT[];
BEGIN
    -- Ensure this is an update operation and the name has changed
    IF TG_OP = 'UPDATE' AND (NEW."name" <> OLD."name" OR NEW."bucket_id" <> OLD."bucket_id") THEN
        -- Retrieve old prefixes
        old_prefixes := "storage"."get_prefixes"(OLD."name");

        -- Remove old prefixes that are only used by this object
        WITH all_prefixes as (
            SELECT unnest(old_prefixes) as prefix
        ),
        can_delete_prefixes as (
             SELECT prefix
             FROM all_prefixes
             WHERE NOT EXISTS (
                 SELECT 1 FROM "storage"."objects"
                 WHERE "bucket_id" = OLD."bucket_id"
                   AND "name" <> OLD."name"
                   AND "name" LIKE (prefix || '%')
             )
         )
        DELETE FROM "storage"."prefixes" WHERE name IN (SELECT prefix FROM can_delete_prefixes);

        -- Add new prefixes
        PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    END IF;
    -- Set the new level
    NEW."level" := "storage"."get_level"(NEW."name");

    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| storage  | objects                  | update_objects_updated_at                        | ROW       | [null,null,"UPDATE",null]               | BEFORE | CREATE TRIGGER update_objects_updated_at BEFORE UPDATE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.update_updated_at_column()                                                                       | update_updated_at_column                     | CREATE OR REPLACE FUNCTION storage.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW; 
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| storage  | prefixes                 | prefixes_create_hierarchy                        | ROW       | ["INSERT",null,null,null]               | BEFORE | CREATE TRIGGER prefixes_create_hierarchy BEFORE INSERT ON storage.prefixes FOR EACH ROW WHEN (pg_trigger_depth() < 1) EXECUTE FUNCTION storage.prefixes_insert_trigger()                                         | prefixes_insert_trigger                      | CREATE OR REPLACE FUNCTION storage.prefixes_insert_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| storage  | prefixes                 | prefixes_delete_hierarchy                        | ROW       | [null,"DELETE",null,null]               | AFTER  | CREATE TRIGGER prefixes_delete_hierarchy AFTER DELETE ON storage.prefixes FOR EACH ROW EXECUTE FUNCTION storage.delete_prefix_hierarchy_trigger()                                                                | delete_prefix_hierarchy_trigger              | CREATE OR REPLACE FUNCTION storage.delete_prefix_hierarchy_trigger()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    prefix text;
BEGIN
    prefix := "storage"."get_prefix"(OLD."name");

    IF coalesce(prefix, '') != '' THEN
        PERFORM "storage"."delete_prefix"(OLD."bucket_id", prefix);
    END IF;

    RETURN OLD;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |