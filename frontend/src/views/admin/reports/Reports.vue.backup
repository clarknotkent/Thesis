<template>
  <AdminLayout>
    <div class="container-fluid">
      <!-- Page Header -->
      <AppPageHeader 
        title="Monthly Immunization Report" 
        subtitle="Comprehensive monthly vaccination statistics and summary"
      >
        <template #actions>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @click="resetFilters">
              <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
            </button>
            <button class="btn btn-outline-primary" @click="generateReport" :disabled="loading">
              <i class="bi bi-arrow-clockwise me-2"></i>Refresh
            </button>
            <button class="btn btn-primary" @click="exportReport" :disabled="loading || !reportData">
              <i class="bi bi-file-earmark-excel me-2"></i>Export Excel
            </button>
          </div>
        </template>
      </AppPageHeader>

      <!-- Filters Card -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label fw-semibold">Month</label>
              <select class="form-select" v-model="filters.month">
                <option v-for="month in months" :key="month.value" :value="month.value">
                  {{ month.label }}
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Year</label>
              <input 
                type="text" 
                class="form-control" 
                v-model="filters.year"
                placeholder="YYYY"
                maxlength="4"
                pattern="[0-9]{4}"
                @input="validateYear"
              >
              <small v-if="yearError" class="text-danger">{{ yearError }}</small>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" @click="generateReport" :disabled="loading">
                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                <i v-else class="bi bi-search me-2"></i>
                Generate Report
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Generating monthly immunization report...</p>
      </div>

      <!-- Report Content -->
      <div v-else-if="reportData" class="card shadow">
        <div class="card-header bg-primary text-white py-3">
          <h5 class="mb-0">
            <i class="bi bi-file-earmark-text me-2"></i>
            Monthly Immunization Report - {{ selectedMonthName }} {{ filters.year }}
          </h5>
        </div>
        <div class="card-body">
          <!-- Report Header Info -->
          <div class="row mb-4">
            <div class="col-md-6">
              <p class="mb-1"><strong>Report Period:</strong> {{ selectedMonthName }} {{ filters.year }}</p>
              <p class="mb-1"><strong>Generated On:</strong> {{ formatDate(new Date()) }}</p>
            </div>
            <div class="col-md-6 text-end">
              <div class="d-inline-block text-start">
                <p class="mb-1"><strong>Total Newborns/Infants Vaccinated:</strong> {{ totals.totalVaccinated }}</p>
                <p class="mb-1"><strong>Fully Immunized Children:</strong> {{ reportData.fullyImmunizedCount || 0 }}</p>
                <p class="mb-1"><strong>Completely Immunized (13-23 months):</strong> {{ reportData.completelyImmunizedCount || 0 }}</p>
              </div>
            </div>
          </div>

          <!-- Immunization Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th class="text-center align-middle" style="width: 35%;">Vaccine / Service</th>
                  <th class="text-center align-middle" style="width: 15%;">Male</th>
                  <th class="text-center align-middle" style="width: 15%;">Female</th>
                  <th class="text-center align-middle bg-info bg-opacity-10" style="width: 15%;">Total</th>
                  <th class="text-center align-middle" style="width: 20%;">Coverage</th>
                </tr>
              </thead>
              <tbody>
                <!-- BCG -->
                <tr>
                  <td class="fw-semibold">BCG</td>
                  <td class="text-center">{{ getVaccineData('BCG').male }}</td>
                  <td class="text-center">{{ getVaccineData('BCG').female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('BCG').total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('BCG').coverage)">
                      {{ getVaccineData('BCG').coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- HepB1 -->
                <tr>
                  <td class="fw-semibold">Hepatitis B 1 (HepB1)</td>
                  <td class="text-center">{{ getVaccineData('HepB', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('HepB', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('HepB', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('HepB', 1).coverage)">
                      {{ getVaccineData('HepB', 1).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- Newborn Screening Test -->
                <tr class="table-secondary">
                  <td class="fw-semibold">Newborn Screening Test</td>
                  <td class="text-center">{{ reportData.newbornScreening?.male || 0 }}</td>
                  <td class="text-center">{{ reportData.newbornScreening?.female || 0 }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ reportData.newbornScreening?.total || 0 }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(reportData.newbornScreening?.coverage || 0)">
                      {{ reportData.newbornScreening?.coverage || 0 }}%
                    </span>
                  </td>
                </tr>

                <!-- Newborn Hearing Screening Test -->
                <tr class="table-secondary">
                  <td class="fw-semibold">Newborn Hearing Screening Test</td>
                  <td class="text-center">{{ reportData.hearingScreening?.male || 0 }}</td>
                  <td class="text-center">{{ reportData.hearingScreening?.female || 0 }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ reportData.hearingScreening?.total || 0 }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(reportData.hearingScreening?.coverage || 0)">
                      {{ reportData.hearingScreening?.coverage || 0 }}%
                    </span>
                  </td>
                </tr>

                <!-- Child Protected at Birth -->
                <tr class="table-secondary">
                  <td class="fw-semibold">Child Protected at Birth</td>
                  <td class="text-center">{{ reportData.protectedAtBirth?.male || 0 }}</td>
                  <td class="text-center">{{ reportData.protectedAtBirth?.female || 0 }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ reportData.protectedAtBirth?.total || 0 }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(reportData.protectedAtBirth?.coverage || 0)">
                      {{ reportData.protectedAtBirth?.coverage || 0 }}%
                    </span>
                  </td>
                </tr>

                <!-- Pentavalent Vaccines (DPT-HiB-HepB) -->
                <tr>
                  <td class="fw-semibold">DPT-HiB-HepB 1</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('Pentavalent', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('Pentavalent', 1).coverage)">
                      {{ getVaccineData('Pentavalent', 1).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">DPT-HiB-HepB 2</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 2).male }}</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 2).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('Pentavalent', 2).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('Pentavalent', 2).coverage)">
                      {{ getVaccineData('Pentavalent', 2).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">DPT-HiB-HepB 3</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 3).male }}</td>
                  <td class="text-center">{{ getVaccineData('Pentavalent', 3).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('Pentavalent', 3).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('Pentavalent', 3).coverage)">
                      {{ getVaccineData('Pentavalent', 3).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- OPV -->
                <tr>
                  <td class="fw-semibold">OPV 1</td>
                  <td class="text-center">{{ getVaccineData('OPV', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('OPV', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('OPV', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('OPV', 1).coverage)">
                      {{ getVaccineData('OPV', 1).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">OPV 2</td>
                  <td class="text-center">{{ getVaccineData('OPV', 2).male }}</td>
                  <td class="text-center">{{ getVaccineData('OPV', 2).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('OPV', 2).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('OPV', 2).coverage)">
                      {{ getVaccineData('OPV', 2).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">OPV 3</td>
                  <td class="text-center">{{ getVaccineData('OPV', 3).male }}</td>
                  <td class="text-center">{{ getVaccineData('OPV', 3).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('OPV', 3).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('OPV', 3).coverage)">
                      {{ getVaccineData('OPV', 3).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- IPV -->
                <tr>
                  <td class="fw-semibold">IPV 1</td>
                  <td class="text-center">{{ getVaccineData('IPV', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('IPV', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('IPV', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('IPV', 1).coverage)">
                      {{ getVaccineData('IPV', 1).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">IPV 2</td>
                  <td class="text-center">{{ getVaccineData('IPV', 2).male }}</td>
                  <td class="text-center">{{ getVaccineData('IPV', 2).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('IPV', 2).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('IPV', 2).coverage)">
                      {{ getVaccineData('IPV', 2).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">IPV 3</td>
                  <td class="text-center">{{ getVaccineData('IPV', 3).male }}</td>
                  <td class="text-center">{{ getVaccineData('IPV', 3).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('IPV', 3).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('IPV', 3).coverage)">
                      {{ getVaccineData('IPV', 3).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- PCV -->
                <tr>
                  <td class="fw-semibold">PCV 1</td>
                  <td class="text-center">{{ getVaccineData('PCV', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('PCV', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('PCV', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('PCV', 1).coverage)">
                      {{ getVaccineData('PCV', 1).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">PCV 2</td>
                  <td class="text-center">{{ getVaccineData('PCV', 2).male }}</td>
                  <td class="text-center">{{ getVaccineData('PCV', 2).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('PCV', 2).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('PCV', 2).coverage)">
                      {{ getVaccineData('PCV', 2).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">PCV 3</td>
                  <td class="text-center">{{ getVaccineData('PCV', 3).male }}</td>
                  <td class="text-center">{{ getVaccineData('PCV', 3).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('PCV', 3).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('PCV', 3).coverage)">
                      {{ getVaccineData('PCV', 3).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- MMR -->
                <tr>
                  <td class="fw-semibold">MMR 1</td>
                  <td class="text-center">{{ getVaccineData('MMR', 1).male }}</td>
                  <td class="text-center">{{ getVaccineData('MMR', 1).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('MMR', 1).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('MMR', 1).coverage)">
                      {{ getVaccineData('MMR', 1).coverage }}%
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-semibold">MMR 2</td>
                  <td class="text-center">{{ getVaccineData('MMR', 2).male }}</td>
                  <td class="text-center">{{ getVaccineData('MMR', 2).female }}</td>
                  <td class="text-center bg-info bg-opacity-10 fw-semibold">{{ getVaccineData('MMR', 2).total }}</td>
                  <td class="text-center">
                    <span class="badge" :class="getCoverageBadge(getVaccineData('MMR', 2).coverage)">
                      {{ getVaccineData('MMR', 2).coverage }}%
                    </span>
                  </td>
                </tr>

                <!-- Summary Rows -->
                <tr class="table-success">
                  <td class="fw-bold">Fully Immunized Child (FIC)</td>
                  <td colspan="3" class="text-center fw-bold">{{ reportData.fullyImmunizedCount || 0 }}</td>
                  <td class="text-center">
                    <span class="badge bg-success">
                      {{ reportData.fullyImmunizedCoverage || 0 }}%
                    </span>
                  </td>
                </tr>
                <tr class="table-info">
                  <td class="fw-bold">Completely Immunized Child (13-23 months)</td>
                  <td colspan="3" class="text-center fw-bold">{{ reportData.completelyImmunizedCount || 0 }}</td>
                  <td class="text-center">
                    <span class="badge bg-info">
                      {{ reportData.completelyImmunizedCoverage || 0 }}%
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Summary Cards -->
          <div class="row mt-4">
            <div class="col-md-3">
              <div class="card bg-primary bg-opacity-10 border-primary">
                <div class="card-body text-center">
                  <h3 class="text-primary mb-2">{{ totals.totalVaccinated }}</h3>
                  <p class="mb-0 text-muted small">Total Vaccinated</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info bg-opacity-10 border-info">
                <div class="card-body text-center">
                  <h3 class="text-info mb-2">{{ totals.maleCount }}</h3>
                  <p class="mb-0 text-muted small">Male</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-danger bg-opacity-10 border-danger">
                <div class="card-body text-center">
                  <h3 class="text-danger mb-2">{{ totals.femaleCount }}</h3>
                  <p class="mb-0 text-muted small">Female</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success bg-opacity-10 border-success">
                <div class="card-body text-center">
                  <h3 class="text-success mb-2">{{ averageCoverage }}%</h3>
                  <p class="mb-0 text-muted small">Average Coverage</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer text-muted">
          <small>
            <i class="bi bi-info-circle me-1"></i>
            This report includes all vaccinations administered during {{ selectedMonthName }} {{ filters.year }}.
            Coverage percentage is calculated based on target population.
          </small>
        </div>
      </div>

      <!-- Empty State -->
      <div v-else class="card shadow">
        <div class="card-body text-center py-5">
          <i class="bi bi-file-earmark-text text-muted" style="font-size: 4rem;"></i>
          <h5 class="mt-3 text-muted">No Report Generated</h5>
          <p class="text-muted">Select a month and year, then click "Generate Report" to view the monthly immunization report.</p>
        </div>
      </div>
    </div>
  </AdminLayout>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import AdminLayout from '@/components/layout/AdminLayout.vue'
import AppPageHeader from '@/components/ui/base/AppPageHeader.vue'
import api from '@/services/api'
import { useToast } from '@/composables/useToast'
import { nowPH, formatPHDate } from '@/utils/dateUtils'

const { addToast } = useToast()

// Reactive state
const loading = ref(false)
const reportData = ref(null)
const yearError = ref('')

// Filters
const filters = ref({
  month: nowPH().month() + 1, // Current month (1-12)
  year: nowPH().year().toString()
})

// Month options
const months = [
  { value: 1, label: 'January' },
  { value: 2, label: 'February' },
  { value: 3, label: 'March' },
  { value: 4, label: 'April' },
  { value: 5, label: 'May' },
  { value: 6, label: 'June' },
  { value: 7, label: 'July' },
  { value: 8, label: 'August' },
  { value: 9, label: 'September' },
  { value: 10, label: 'October' },
  { value: 11, label: 'November' },
  { value: 12, label: 'December' }
]

// Computed properties
const selectedMonthName = computed(() => {
  const month = months.find(m => m.value === filters.value.month)
  return month ? month.label : ''
})

const totals = computed(() => {
  if (!reportData.value || !reportData.value.vaccines) {
    return { totalVaccinated: 0, maleCount: 0, femaleCount: 0 }
  }

  let totalVaccinated = 0
  let maleCount = 0
  let femaleCount = 0

  Object.values(reportData.value.vaccines).forEach(vaccine => {
    if (Array.isArray(vaccine)) {
      vaccine.forEach(dose => {
        totalVaccinated += dose.total || 0
        maleCount += dose.male || 0
        femaleCount += dose.female || 0
      })
    } else {
      totalVaccinated += vaccine.total || 0
      maleCount += vaccine.male || 0
      femaleCount += vaccine.female || 0
    }
  })

  return { totalVaccinated, maleCount, femaleCount }
})

const averageCoverage = computed(() => {
  if (!reportData.value || !reportData.value.vaccines) return 0

  let totalCoverage = 0
  let count = 0

  Object.values(reportData.value.vaccines).forEach(vaccine => {
    if (Array.isArray(vaccine)) {
      vaccine.forEach(dose => {
        if (dose.coverage !== undefined) {
          totalCoverage += dose.coverage
          count++
        }
      })
    } else if (vaccine.coverage !== undefined) {
      totalCoverage += vaccine.coverage
      count++
    }
  })

  return count > 0 ? Math.round(totalCoverage / count) : 0
})

// Methods
const validateYear = (event) => {
  const value = event.target.value
  
  // Only allow numbers
  const cleaned = value.replace(/[^0-9]/g, '')
  filters.value.year = cleaned
  
  // Validate year format and range
  if (cleaned.length === 4) {
    const yearNum = parseInt(cleaned)
    const currentYear = nowPH().year()
    
    if (yearNum < 1900 || yearNum > currentYear + 10) {
      yearError.value = `Year must be between 1900 and ${currentYear + 10}`
    } else {
      yearError.value = ''
    }
  } else if (cleaned.length > 0) {
    yearError.value = 'Year must be 4 digits'
  } else {
    yearError.value = ''
  }
}

const generateReport = async () => {
  try {
    // Validate year before generating report
    if (!filters.value.year || filters.value.year.length !== 4) {
      addToast({
        title: 'Validation Error',
        message: 'Please enter a valid 4-digit year',
        type: 'error'
      })
      return
    }

    if (yearError.value) {
      addToast({
        title: 'Validation Error',
        message: yearError.value,
        type: 'error'
      })
      return
    }

    loading.value = true

    const response = await api.get('/reports/monthly-immunization', {
      params: {
        month: filters.value.month,
        year: parseInt(filters.value.year)
      }
    })

    reportData.value = response.data.data

    addToast({
      title: 'Success',
      message: 'Report generated successfully',
      type: 'success'
    })
  } catch (error) {
    console.error('Error generating report:', error)
    addToast({
      title: 'Error',
      message: error.response?.data?.error || 'Failed to generate report',
      type: 'error'
    })
    reportData.value = null
  } finally {
    loading.value = false
  }
}

const getVaccineData = (vaccineName, dose = null) => {
  if (!reportData.value || !reportData.value.vaccines) {
    return { male: 0, female: 0, total: 0, coverage: 0 }
  }

  const vaccineData = reportData.value.vaccines[vaccineName]

  if (!vaccineData) {
    return { male: 0, female: 0, total: 0, coverage: 0 }
  }

  if (dose !== null && Array.isArray(vaccineData)) {
    const doseData = vaccineData.find(d => d.dose === dose)
    return doseData || { male: 0, female: 0, total: 0, coverage: 0 }
  }

  if (!Array.isArray(vaccineData)) {
    return vaccineData
  }

  return { male: 0, female: 0, total: 0, coverage: 0 }
}

const getCoverageBadge = (coverage) => {
  if (coverage >= 95) return 'bg-success'
  if (coverage >= 80) return 'bg-primary'
  if (coverage >= 60) return 'bg-warning text-dark'
  return 'bg-danger'
}

const resetFilters = () => {
  filters.value.month = nowPH().month() + 1
  filters.value.year = nowPH().year().toString()
  yearError.value = ''
  reportData.value = null
}

const exportReport = () => {
  if (!reportData.value) return

  try {
    // Create CSV content
    let csv = 'Monthly Immunization Report\n'
    csv += `Report Period:,${selectedMonthName.value} ${filters.value.year}\n`
    csv += `Generated On:,${formatDate(new Date())}\n\n`
    
    csv += 'Vaccine/Service,Male,Female,Total,Coverage %\n'
    
    // Add vaccine data
    const vaccines = [
      { name: 'BCG', key: 'BCG', dose: null },
      { name: 'Hepatitis B 1 (HepB1)', key: 'HepB', dose: 1 },
      { name: 'Newborn Screening Test', key: 'newbornScreening' },
      { name: 'Newborn Hearing Screening Test', key: 'hearingScreening' },
      { name: 'Child Protected at Birth', key: 'protectedAtBirth' },
      { name: 'DPT-HiB-HepB 1', key: 'Pentavalent', dose: 1 },
      { name: 'DPT-HiB-HepB 2', key: 'Pentavalent', dose: 2 },
      { name: 'DPT-HiB-HepB 3', key: 'Pentavalent', dose: 3 },
      { name: 'OPV 1', key: 'OPV', dose: 1 },
      { name: 'OPV 2', key: 'OPV', dose: 2 },
      { name: 'OPV 3', key: 'OPV', dose: 3 },
      { name: 'IPV 1', key: 'IPV', dose: 1 },
      { name: 'IPV 2', key: 'IPV', dose: 2 },
      { name: 'IPV 3', key: 'IPV', dose: 3 },
      { name: 'PCV 1', key: 'PCV', dose: 1 },
      { name: 'PCV 2', key: 'PCV', dose: 2 },
      { name: 'PCV 3', key: 'PCV', dose: 3 },
      { name: 'MMR 1', key: 'MMR', dose: 1 },
      { name: 'MMR 2', key: 'MMR', dose: 2 }
    ]

    vaccines.forEach(vaccine => {
      let data
      if (vaccine.dose !== undefined && vaccine.dose !== null) {
        data = getVaccineData(vaccine.key, vaccine.dose)
      } else if (vaccine.key in (reportData.value || {})) {
        data = reportData.value[vaccine.key]
      } else {
        data = getVaccineData(vaccine.key)
      }
      
      csv += `${vaccine.name},${data.male || 0},${data.female || 0},${data.total || 0},${data.coverage || 0}\n`
    })

    csv += '\n'
    csv += `Fully Immunized Child,,,${reportData.value.fullyImmunizedCount || 0},${reportData.value.fullyImmunizedCoverage || 0}\n`
    csv += `Completely Immunized Child (13-23 months),,,${reportData.value.completelyImmunizedCount || 0},${reportData.value.completelyImmunizedCoverage || 0}\n`

    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)
    
    link.setAttribute('href', url)
    link.setAttribute('download', `Monthly_Immunization_Report_${selectedMonthName.value}_${filters.value.year}.csv`)
    link.style.visibility = 'hidden'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)

    addToast({
      title: 'Success',
      message: 'Report exported successfully',
      type: 'success'
    })
  } catch (error) {
    console.error('Error exporting report:', error)
    addToast({
      title: 'Error',
      message: 'Failed to export report',
      type: 'error'
    })
  }
}

const formatDate = (date) => {
  return formatPHDate(date)
}

// Lifecycle
onMounted(() => {
  // Auto-generate report for current month on mount
  generateReport()
})
</script>

<style scoped>
.table th {
  font-weight: 600;
  font-size: 0.9rem;
}

.table td {
  vertical-align: middle;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}

.badge {
  font-size: 0.85rem;
  padding: 0.35rem 0.65rem;
}

.card {
  border-radius: 0.5rem;
}

.card-header {
  border-top-left-radius: 0.5rem;
  border-top-right-radius: 0.5rem;
}
</style>
